<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Detalle Producto - Tienda RA4</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo"><a href="dashboard.html">Mi Tienda</a></div>
        <div class="nav-links">
            <a href="dashboard.html">Inicio</a>
            <a href="cart.html">Carrito (<span id="cart-count">0</span>)</a>
        </div>
    </nav>

    <div class="container">
        <div id="product-detail" class="product-detail-container">
            </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('token')) window.location.href = 'login.html';

            const prodId = parseInt(localStorage.getItem('current_product_id'));
            const tiendaData = JSON.parse(localStorage.getItem('tienda_data'));
            const producto = tiendaData.productos.find(p => p.id === prodId);

            if(producto) {
                // 1. Renderizar detalles
                const container = document.getElementById('product-detail');
                container.innerHTML = `
                    <div class="detail-image">
                        <img src="${producto.imagen}" onerror="this.src='https://via.placeholder.com/300'" style="width:100%; border-radius:8px;">
                    </div>
                    <div class="detail-info">
                        <h2>${producto.nombre}</h2>
                        <h3 style="color: var(--accent);">${producto.precio} €</h3>
                        <p>${producto.descripcion}</p>
                        <button class="btn" onclick="agregarAlCarrito(${producto.id})">Añadir al Carrito</button>
                        <br><br>
                        <button class="btn-danger" onclick="window.history.back()">Volver</button>
                    </div>
                `;

                // 2. Lógica "Vistos Recientemente" (Requisito del Anexo)
                registrarVisto(producto);
            }
            actualizarContador();
        });

        function registrarVisto(producto) {
            let vistos = JSON.parse(localStorage.getItem('productos_vistos')) || [];
            // Evitar duplicados: si ya está, lo quitamos para ponerlo el primero (o lo dejamos, según prefieras)
            vistos = vistos.filter(p => p.id !== producto.id);
            // Añadir al principio
            vistos.unshift(producto);
            // Mantener solo los últimos 5, por ejemplo
            if(vistos.length > 5) vistos.pop();
            
            localStorage.setItem('productos_vistos', JSON.stringify(vistos));
        }

        function agregarAlCarrito(id) {
            // Misma lógica que en el dashboard
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const tiendaData = JSON.parse(localStorage.getItem('tienda_data'));
            const prod = tiendaData.productos.find(p => p.id === id);
            carrito.push(prod);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            actualizarContador();
            alert('Producto añadido al carrito');
        }

        function actualizarContador() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            document.getElementById('cart-count').textContent = carrito.length;
        }
    </script>
</body>
</html>